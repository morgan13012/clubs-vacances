<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carte des Clubs de Vacances</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css"/>
<!-- MapLibre GL CSS (JS loaded after Leaflet) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl/4.1.2/maplibre-gl.min.css"/>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');
:root{
  --primary:#0C5C8F;--primary-light:#1A7AB5;--primary-dark:#083D5F;
  --accent:#F59E0B;--accent-light:#FCD34D;--bg:#F0F4F8;--card:#FFF;
  --text:#1E293B;--text-light:#64748B;--border:#E2E8F0;--success:#10B981;
  --danger:#EF4444;--radius:10px;--shadow:0 2px 12px rgba(0,0,0,.08);--shadow-lg:0 8px 32px rgba(0,0,0,.12);
}
*{margin:0;padding:0;box-sizing:border-box}
.embed-container,.modal-backdrop,.modal-content,.filters-overlay,.login-overlay{font-family:'DM Sans',-apple-system,sans-serif;color:var(--text);line-height:1.5}
.modal-content,.embed-container{background:var(--bg)}
.embed-container{width:100%;height:420px;position:relative;border-radius:var(--radius);overflow:hidden;background:var(--primary-dark);cursor:pointer}
.embed-map{width:100%;height:100%;opacity:.85;pointer-events:none}
.embed-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,rgba(12,92,143,.7),rgba(8,61,95,.85));color:#fff;text-align:center;transition:background .3s;z-index:500}
.embed-container:hover .embed-overlay{background:linear-gradient(135deg,rgba(12,92,143,.5),rgba(8,61,95,.65))}
.embed-overlay h2{font-size:1.4rem;font-weight:700;margin-bottom:4px}
.embed-overlay p{font-size:.95rem;opacity:.9;margin-bottom:16px}
.embed-cta{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:var(--primary-dark);font-weight:700;font-size:1rem;padding:12px 28px;border-radius:50px;border:none;cursor:pointer;transition:transform .2s,box-shadow .2s;box-shadow:0 4px 16px rgba(245,158,11,.4)}
.embed-cta:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(245,158,11,.5)}
.embed-count{font-size:.85rem;margin-top:10px;opacity:.8}
.modal-backdrop{display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);animation:fadeIn .3s}
.modal-backdrop.active{display:flex}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(40px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-content{position:absolute;inset:12px;background:var(--bg);border-radius:16px;overflow:hidden;display:flex;flex-direction:column;animation:slideUp .35s;box-shadow:var(--shadow-lg)}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:10px 20px;background:var(--primary);color:#fff;flex-shrink:0;gap:10px;flex-wrap:nowrap}
.topbar-left{display:flex;align-items:center;gap:10px;font-weight:700;font-size:1.05rem}
.topbar-count{background:rgba(255,255,255,.2);padding:3px 12px;border-radius:20px;font-size:.78rem;font-weight:600}
.topbar-right{display:flex;align-items:center;gap:8px}
.btn-to-login{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.15);border:1.5px solid rgba(255,255,255,.3);color:#fff;padding:6px 14px;border-radius:8px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-to-login:hover{background:rgba(255,255,255,.25)}
.btn-to-logout{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8);padding:5px 10px;border-radius:6px;font-family:inherit;font-size:.75rem;cursor:pointer}
.btn-to-logout:hover{background:rgba(255,255,255,.2)}
.to-user-badge{display:flex;align-items:center;gap:6px;font-size:.8rem;font-weight:600}
.to-user-dot{width:10px;height:10px;border-radius:50%;border:1.5px solid #fff}
.btn-close{background:rgba(255,255,255,.15);border:none;color:#fff;width:36px;height:36px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;transition:background .2s}
.btn-close:hover{background:rgba(255,255,255,.3)}
.main-layout{flex:1;display:flex;overflow:hidden}
.sidebar{width:380px;flex-shrink:0;display:flex;flex-direction:column;background:var(--card);border-right:1px solid var(--border);overflow:hidden}
.search-box{padding:12px 16px 8px;border-bottom:1px solid var(--border)}
.search-wrap{display:flex;align-items:center;background:var(--bg);border-radius:8px;padding:0 12px;gap:8px;border:2px solid transparent;transition:border-color .2s}
.search-wrap:focus-within{border-color:var(--primary-light)}
.search-wrap svg{color:var(--text-light);flex-shrink:0}
.search-wrap input{flex:1;border:none;background:transparent;padding:9px 0;font-family:inherit;font-size:.88rem;color:var(--text);outline:none}
.filters-section{padding:8px 16px;border-bottom:1px solid var(--border)}
.filters-toggle{display:flex;align-items:center;justify-content:space-between;background:none;border:none;width:100%;cursor:pointer;font-family:inherit;font-size:.83rem;font-weight:600;color:var(--primary);padding:4px 0}
.filters-toggle svg{transition:transform .3s}
.filters-toggle.open svg{transform:rotate(180deg)}
.filters-body{display:none;padding-top:8px;max-height:55vh;overflow-y:auto}
.filters-body.open{display:block}
.filter-row{margin-bottom:8px}
.filter-label{display:block;font-size:.7rem;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.filter-select{width:100%;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-family:inherit;font-size:.83rem;color:var(--text);background:#fff;cursor:pointer;outline:none}
.filter-chips{display:flex;flex-wrap:wrap;gap:5px}
.filter-chip{padding:4px 10px;border-radius:20px;border:1.5px solid var(--border);background:#fff;font-size:.76rem;font-weight:500;cursor:pointer;transition:all .15s;color:var(--text);user-select:none}
.filter-chip:hover{border-color:var(--primary-light)}
.filter-chip.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.filter-group-label{font-size:.66rem;font-weight:700;color:var(--text-light);text-transform:uppercase;letter-spacing:.5px;margin:6px 0 4px;padding-top:5px;border-top:1px solid var(--border)}
.filters-actions{display:flex;gap:8px;margin-top:10px;padding-top:6px;border-top:1px solid var(--border)}
.btn-reset{flex:1;padding:7px;border:1.5px solid var(--border);border-radius:6px;background:#fff;font-family:inherit;font-size:.78rem;font-weight:600;color:var(--text-light);cursor:pointer}
.btn-reset:hover{border-color:var(--primary-light);color:var(--primary)}
.active-count{display:inline-flex;align-items:center;justify-content:center;background:#EF4444;color:#fff;font-size:.63rem;font-weight:700;width:17px;height:17px;border-radius:50%;margin-left:5px}
.btn-add-club{display:flex;align-items:center;justify-content:center;gap:6px;margin:10px 16px;padding:10px;background:var(--success);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:.88rem;font-weight:700;cursor:pointer;transition:background .2s}
.btn-add-club:hover{background:#059669}
.club-list-header{padding:8px 16px;font-size:.78rem;color:var(--text-light);font-weight:600;border-bottom:1px solid var(--border);background:var(--bg)}
.club-list{flex:1;overflow-y:auto;scroll-behavior:smooth}
.club-item{padding:11px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s}
.club-item:hover{background:#F8FAFC}
.club-item.active{background:#EFF6FF;border-left:3px solid var(--primary)}
.club-item-name{font-weight:600;font-size:.9rem;color:var(--text);margin-bottom:3px}
.club-item-meta{display:flex;align-items:center;gap:6px;font-size:.76rem;color:var(--text-light);flex-wrap:wrap}
.club-item-to{display:inline-flex;padding:2px 8px;border-radius:4px;font-size:.7rem;font-weight:600;color:#fff}
.stars{color:var(--accent);font-size:.76rem;text-shadow:0 0 1px rgba(0,0,0,.3)}
.map-panel{flex:1;position:relative}
#mainMap{width:100%;height:100%}
.map-legend{position:absolute;bottom:30px;left:10px;z-index:700;background:rgba(255,255,255,.95);backdrop-filter:blur(6px);border-radius:8px;padding:10px 14px;box-shadow:var(--shadow);max-height:260px;overflow-y:auto;font-size:.73rem;max-width:190px}
.map-legend h4{font-size:.68rem;text-transform:uppercase;letter-spacing:.5px;color:var(--text-light);margin-bottom:5px;font-weight:700}
.legend-item{display:flex;align-items:center;gap:6px;padding:2px 0;cursor:pointer;transition:opacity .15s}
.legend-item:hover{opacity:.7}
.legend-item.dimmed{opacity:.3}
.legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;border:1.5px solid rgba(0,0,0,.1)}
.legend-label{font-weight:500;color:var(--text)}
.legend-cnt{color:var(--text-light);margin-left:auto}
.detail-panel{position:absolute;top:0;right:0;width:420px;max-width:100%;height:100%;background:var(--card);box-shadow:-4px 0 24px rgba(0,0,0,.1);z-index:800;transform:translateX(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);overflow-y:auto;display:flex;flex-direction:column}
.detail-panel.open{transform:translateX(0)}
.detail-header{position:sticky;top:0;color:#fff;padding:16px 20px;z-index:2}
.detail-close{position:absolute;top:12px;right:12px;background:rgba(255,255,255,.2);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.95rem}
.detail-close:hover{background:rgba(255,255,255,.35)}
.detail-name{font-size:1.15rem;font-weight:700;margin-bottom:3px;padding-right:36px}
.detail-loc{font-size:.85rem;opacity:.9;display:flex;align-items:center;gap:6px}
.detail-loc .stars{color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.3)}
.detail-badges{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px}
.detail-badge{padding:3px 9px;border-radius:20px;font-size:.71rem;font-weight:600;background:rgba(255,255,255,.2)}
.detail-actions{display:flex;gap:8px;margin-top:10px}
.btn-edit-club{display:flex;align-items:center;gap:5px;padding:7px 14px;background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.4);color:#fff;border-radius:6px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;transition:background .2s}
.btn-edit-club:hover{background:rgba(255,255,255,.35)}
.btn-delete-club{display:flex;align-items:center;gap:5px;padding:7px 14px;background:rgba(239,68,68,.25);border:1.5px solid rgba(239,68,68,.5);color:#fff;border-radius:6px;font-family:inherit;font-size:.8rem;font-weight:600;cursor:pointer;transition:background .2s}
.btn-delete-club:hover{background:rgba(239,68,68,.45)}
.detail-body{padding:18px;flex:1}
.detail-section{margin-bottom:18px}
.detail-section-title{font-size:.71rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--primary);margin-bottom:8px;padding-bottom:5px;border-bottom:2px solid var(--primary);display:flex;align-items:center;gap:6px}
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px}
.detail-field{padding:7px 9px;background:var(--bg);border-radius:6px}
.detail-field.full{grid-column:1/-1}
.detail-field-label{font-size:.66rem;font-weight:600;text-transform:uppercase;letter-spacing:.3px;color:var(--text-light);margin-bottom:1px}
.detail-field-value{font-size:.82rem;font-weight:500;color:var(--text)}
.detail-field-value.yes{color:var(--success);font-weight:600}
.detail-field-value.no{color:var(--danger)}
.login-overlay{display:none;position:fixed;inset:0;z-index:20000;background:rgba(0,0,0,.5);backdrop-filter:blur(3px);align-items:center;justify-content:center}
.login-overlay.active{display:flex}
.login-box{background:#fff;border-radius:16px;padding:32px;width:380px;max-width:90vw;box-shadow:var(--shadow-lg);text-align:center}
.login-box h3{font-size:1.1rem;font-weight:700;margin-bottom:4px;color:var(--text)}
.login-box p{font-size:.85rem;color:var(--text-light);margin-bottom:20px}
.login-input{width:100%;padding:12px 16px;border:2px solid var(--border);border-radius:8px;font-family:inherit;font-size:1rem;text-align:center;letter-spacing:3px;font-weight:700;color:var(--text);outline:none;transition:border-color .2s}
.login-input:focus{border-color:var(--primary)}
.login-input.error{border-color:var(--danger);animation:shake .4s}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-8px)}50%{transform:translateX(8px)}75%{transform:translateX(-4px)}}
.login-error{color:var(--danger);font-size:.8rem;margin-top:8px;display:none}
.login-btn{width:100%;margin-top:16px;padding:12px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:.95rem;font-weight:700;cursor:pointer;transition:background .2s}
.login-btn:hover{background:var(--primary-light)}
.login-cancel{background:none;border:none;color:var(--text-light);font-family:inherit;font-size:.85rem;margin-top:12px;cursor:pointer}
.login-cancel:hover{color:var(--text)}
.stats-overlay{display:none;position:fixed;inset:0;z-index:20000;background:rgba(0,0,0,.5);backdrop-filter:blur(3px);align-items:center;justify-content:center}
.stats-overlay.active{display:flex}
.stats-box{background:#fff;border-radius:16px;width:800px;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;box-shadow:var(--shadow-lg);overflow:hidden}
.stats-header{padding:18px 24px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.stats-header h3{font-size:1.05rem;font-weight:700;margin:0}
.stats-body{padding:20px 24px;overflow-y:auto;flex:1}
.stats-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:20px}
.stat-card{background:var(--bg);border-radius:10px;padding:16px;text-align:center}
.stat-card-value{font-size:1.8rem;font-weight:700;color:var(--primary)}
.stat-card-label{font-size:.78rem;color:var(--text-light);margin-top:2px;font-weight:600}
.stats-section{margin-bottom:20px}
.stats-section h4{font-size:.82rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--primary);margin-bottom:10px;padding-bottom:6px;border-bottom:2px solid var(--primary)}
.stats-table{width:100%;border-collapse:collapse;font-size:.82rem}
.stats-table th{text-align:left;padding:6px 10px;background:var(--bg);font-weight:600;color:var(--text-light);font-size:.72rem;text-transform:uppercase;letter-spacing:.3px}
.stats-table td{padding:6px 10px;border-bottom:1px solid var(--border)}
.stats-table td:last-child{text-align:right;font-weight:700;color:var(--primary)}
.stats-bar{height:6px;background:var(--border);border-radius:3px;margin-top:3px;overflow:hidden}
.stats-bar-fill{height:100%;background:var(--primary);border-radius:3px}
.stats-period{display:flex;gap:8px;margin-bottom:16px}
.stats-period-btn{padding:6px 14px;border-radius:6px;border:1.5px solid var(--border);background:#fff;font-family:inherit;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .2s;color:var(--text-light)}
.stats-period-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.stats-date-range{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.stats-date-input{padding:6px 10px;border:1.5px solid var(--border);border-radius:6px;font-family:inherit;font-size:.78rem;color:var(--text);background:#fff;outline:none}
.stats-date-input:focus{border-color:var(--primary)}
.stats-date-btn{padding:6px 14px;border-radius:6px;border:none;background:var(--primary);color:#fff;font-family:inherit;font-size:.78rem;font-weight:600;cursor:pointer}	
.form-overlay{display:none;position:fixed;inset:0;z-index:20000;background:rgba(0,0,0,.5);backdrop-filter:blur(3px);align-items:center;justify-content:center}
.form-overlay.active{display:flex}
.form-box{background:#fff;border-radius:16px;width:700px;max-width:95vw;max-height:90vh;display:flex;flex-direction:column;box-shadow:var(--shadow-lg);overflow:hidden}
.form-header{padding:18px 24px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.form-header h3{font-size:1.05rem;font-weight:700}
.form-close{background:rgba(255,255,255,.2);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.95rem}
.form-body{padding:20px 24px;overflow-y:auto;flex:1}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.form-row.full{grid-template-columns:1fr}
.form-group{display:flex;flex-direction:column}
.form-group label{font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.4px;color:var(--text-light);margin-bottom:3px}
.form-group input,.form-group select,.form-group textarea{padding:8px 10px;border:1.5px solid var(--border);border-radius:6px;font-family:inherit;font-size:.85rem;color:var(--text);outline:none;transition:border-color .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--primary)}
.form-group textarea{resize:vertical;min-height:60px}
.form-section-label{font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--primary);margin:16px 0 8px;padding-top:10px;border-top:2px solid var(--primary)}
.form-map-section{margin:12px 0}
.form-map-label{font-size:.72rem;font-weight:600;color:var(--text-light);text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px}
.form-map-help{font-size:.75rem;color:var(--text-light);margin-bottom:6px;font-style:italic}
#formMap{width:100%;height:200px;border-radius:8px;border:2px solid var(--border)}
.form-coords{display:flex;gap:10px;margin-top:6px}
.form-coords input{flex:1}
.form-footer{padding:14px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;flex-shrink:0;background:#FAFBFC}
.form-btn-cancel{padding:9px 20px;border:1.5px solid var(--border);border-radius:8px;background:#fff;font-family:inherit;font-size:.85rem;font-weight:600;color:var(--text-light);cursor:pointer}
.form-btn-save{padding:9px 24px;border:none;border-radius:8px;background:var(--success);font-family:inherit;font-size:.85rem;font-weight:700;color:#fff;cursor:pointer;transition:background .2s;display:flex;align-items:center;gap:6px}
.form-btn-save:hover{background:#059669}
.form-btn-save:disabled{background:#94A3B8;cursor:not-allowed}
.form-saving{display:none;align-items:center;gap:8px;font-size:.85rem;color:var(--text-light)}
.spinner{width:18px;height:18px;border:2.5px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
/* Confirm dialog */
.confirm-overlay{display:none;position:fixed;inset:0;z-index:25000;background:rgba(0,0,0,.5);backdrop-filter:blur(3px);align-items:center;justify-content:center}
.confirm-overlay.active{display:flex}
.confirm-box{background:#fff;border-radius:16px;padding:28px 32px;width:400px;max-width:90vw;box-shadow:var(--shadow-lg);text-align:center}
.confirm-box h3{font-size:1rem;font-weight:700;color:var(--danger);margin-bottom:8px}
.confirm-box p{font-size:.88rem;color:var(--text-light);margin-bottom:20px}
.confirm-box .club-to-delete{font-weight:700;color:var(--text)}
.confirm-btns{display:flex;gap:10px;justify-content:center}
.confirm-btns button{padding:10px 24px;border-radius:8px;font-family:inherit;font-size:.88rem;font-weight:700;cursor:pointer;border:none}
.btn-confirm-cancel{background:var(--bg);color:var(--text-light);border:1.5px solid var(--border)!important}
.btn-confirm-delete{background:var(--danger);color:#fff}
.toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(100px);z-index:30000;padding:14px 28px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.9rem;font-weight:600;color:#fff;box-shadow:var(--shadow-lg);transition:transform .4s cubic-bezier(.4,0,.2,1);pointer-events:none}
.toast.show{transform:translateX(-50%) translateY(0)}
.toast.success{background:var(--success)}
.toast.error{background:var(--danger)}
.no-results{padding:40px 20px;text-align:center;color:var(--text-light)}
.no-results p{font-size:.88rem;margin-top:8px}
.leaflet-popup-content-wrapper{border-radius:8px!important;padding:0!important;box-shadow:var(--shadow-lg)!important}
.leaflet-popup-content{margin:0!important;min-width:220px}
.leaflet-popup-tip{display:none}
.popup-inner{padding:12px 14px;font-family:'DM Sans',sans-serif}
.popup-inner h3{font-size:.88rem;font-weight:700;color:var(--text);margin-bottom:2px}
.popup-inner .popup-to{display:inline-flex;padding:1px 7px;border-radius:3px;font-size:.68rem;font-weight:600;color:#fff;margin-bottom:3px}
.popup-inner p{font-size:.78rem;color:var(--text-light);margin-bottom:5px}
.popup-btn{display:inline-block;background:var(--primary);color:#fff;font-size:.73rem;font-weight:600;padding:5px 12px;border-radius:4px;cursor:pointer;border:none;font-family:inherit}
.popup-btn:hover{background:var(--primary-light)}
.marker-cluster-small,.marker-cluster-medium,.marker-cluster-large{background:rgba(12,92,143,.12)!important}
.marker-cluster-small div,.marker-cluster-medium div,.marker-cluster-large div{background:var(--primary)!important;color:#fff!important;font-family:'DM Sans',sans-serif!important;font-weight:700!important}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@media(max-width:768px){
  .modal-content{inset:0;border-radius:0}
  .main-layout{flex-direction:column;height:100%}
  .sidebar{width:100%;height:55%;min-height:200px;border-right:none;border-bottom:1px solid var(--border);overflow-y:auto}
  .map-panel{width:100%;height:45%;min-height:180px;position:relative}
  .map-legend{display:none!important}
  .filters-body.open{display:none!important}
  .detail-panel{width:100%;position:fixed;inset:0;z-index:10001;transform:translateY(100%);border-radius:0}
  .detail-panel.open{transform:translateY(0)}
  .embed-container{height:300px}
  .embed-overlay h2{font-size:1.1rem}
  .form-box{max-width:100vw;max-height:100vh;border-radius:0}
  .form-row{grid-template-columns:1fr}
  .topbar{padding:8px 12px}
  .topbar-left{font-size:.9rem}
}
	
.filters-overlay{display:none;position:fixed;inset:0;z-index:10002;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);align-items:flex-end;justify-content:center}
.filters-popup{background:var(--card);width:100%;max-height:85vh;border-radius:16px 16px 0 0;overflow-y:auto;padding:0;display:flex;flex-direction:column;animation:slideUp .3s}
.filters-popup-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--card);z-index:1}
.filters-popup-header h3{font-size:1rem;color:var(--text);margin:0}
.filters-popup-close{background:none;border:none;font-size:1.3rem;cursor:pointer;color:var(--text-light);padding:4px 8px}
.filters-popup-body{padding:16px 20px;overflow-y:auto}
.filters-popup-footer{padding:12px 20px;border-top:1px solid var(--border);display:flex;gap:10px;position:sticky;bottom:0;background:var(--card)}
.filters-popup-footer .btn-apply{flex:2;padding:10px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-family:inherit;font-size:.9rem;font-weight:700;cursor:pointer}
.filters-popup-footer .btn-reset{flex:1}	
	
</style>
</head>
<body>

<div class="embed-container" id="embedContainer" onclick="openModal()">
  <div id="embedMap" class="embed-map"></div>
  <div class="embed-overlay" id="embedOverlay"><h2>üåç Carte des Clubs de Vacances</h2><p>Chargement‚Ä¶</p></div>
	<span style="position:absolute;bottom:8px;right:12px;z-index:600;font-size:.65rem;color:#fff;opacity:.7;pointer-events:none;">¬© TourMag.com 2026</span>
</div>

<div class="modal-backdrop" id="modal">
<div class="modal-content">
  <div class="topbar">
    <div class="topbar-left">
      <img src="https://www.tourmag.com/my/tourmag/dossiers_speciaux/2026_03_clubs/carte/Logo-TourMagGlobe-BlancCMJN_DEFINITIF.png" style="height:28px!important;width:auto!important;max-width:120px!important;">
      Clubs de Vacances <span class="topbar-count" id="topbarCount"></span>
    </div>
    <div class="topbar-right">
      <div id="toUserInfo" style="display:none"><span class="to-user-badge"><span class="to-user-dot" id="toUserDot"></span><span id="toUserName"></span></span></div>
      <button class="btn-to-login" id="btnToLogin" onclick="showLogin()"><svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg> Espace TO</button>
      <button class="btn-to-logout" id="btnToLogout" style="display:none" onclick="logoutTO()">D√©connexion</button>
      <button class="btn-to-login" id="btnStats" style="display:none" onclick="openStats()"><svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M18 20V10M12 20V4M6 20v-6"/></svg> Stats</button>
      <button class="btn-close" onclick="closeModal()">‚úï</button>
    </div>
  </div>
  <div class="main-layout">
	  
	 
    <div class="sidebar">
      <div class="search-box"><div class="search-wrap"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg><input type="text" id="searchInput" placeholder="Rechercher un club, ville, pays‚Ä¶" oninput="applyFilters()"></div></div>
      <div class="filters-section">
        <button class="filters-toggle" id="filtersToggle" onclick="toggleFilters()"><span>‚öô Filtres avanc√©s <span class="active-count" id="activeCount" style="display:none">0</span></span><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg></button>
        <div class="filters-body" id="filtersBody">
          <div class="filter-row"><span class="filter-label">Club de Vacances</span><select class="filter-select" id="filterTO" onchange="applyFilters()"><option value="">Tous</option></select></div>
          <div class="filter-row"><span class="filter-label">Pays</span><select class="filter-select" id="filterPays" onchange="applyFilters()"><option value="">Tous</option></select></div>
          <div class="filter-row"><span class="filter-label">√âtoiles</span><div class="filter-chips" id="filterStars"><div class="filter-chip active" data-val="" onclick="toggleStar(this)">Toutes</div><div class="filter-chip" data-val="3" onclick="toggleStar(this)">‚òÖ‚òÖ‚òÖ</div><div class="filter-chip" data-val="4" onclick="toggleStar(this)">‚òÖ‚òÖ‚òÖ‚òÖ</div><div class="filter-chip" data-val="5" onclick="toggleStar(this)">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div></div></div>
          <div class="filter-group-label">Formule & Restauration</div>
          <div class="filter-row"><div class="filter-chips"><div class="filter-chip" data-filter="allInclusive" onclick="toggleChip(this)">All Inclusive</div><div class="filter-chip" data-filter="demiPension" onclick="toggleChip(this)">Demi-pension</div><div class="filter-chip" data-filter="buffet" onclick="toggleChip(this)">Buffet</div></div></div>
          <div class="filter-group-label">Public & Accessibilit√©</div>
          <div class="filter-row"><div class="filter-chips"><div class="filter-chip" data-filter="adultOnly" onclick="toggleChip(this)">Adult Only</div><div class="filter-chip" data-filter="enfants" onclick="toggleChip(this)">Clubs enfants</div><div class="filter-chip" data-filter="pmr" onclick="toggleChip(this)">Acc√®s PMR</div></div></div>
          <div class="filter-group-label">Localisation & Acc√®s</div>
          <div class="filter-row"><div class="filter-chips"><div class="filter-chip" data-filter="mer" onclick="toggleChip(this)">Acc√®s direct mer</div><div class="filter-chip" data-filter="transferts" onclick="toggleChip(this)">Transferts</div></div></div>
          <div class="filter-group-label">√âquipements & Sport</div>
          <div class="filter-row"><div class="filter-chips"><div class="filter-chip" data-filter="piscine" onclick="toggleChip(this)">Piscine(s)</div><div class="filter-chip" data-filter="sport" onclick="toggleChip(this)">Salle de sport</div><div class="filter-chip" data-filter="equipSport" onclick="toggleChip(this)">√âquip. sportifs</div></div></div>
          <div class="filter-group-label">Animation</div>
          <div class="filter-row"><div class="filter-chips"><div class="filter-chip" data-filter="animFr" onclick="toggleChip(this)">Francophone</div><div class="filter-chip" data-filter="animJour" onclick="toggleChip(this)">Journ√©e</div><div class="filter-chip" data-filter="animSoir" onclick="toggleChip(this)">Soir√©e</div></div></div>
          <div class="filter-group-label">Services</div>
          <div class="filter-row"><div class="filter-chips"><div class="filter-chip" data-filter="wifi" onclick="toggleChip(this)">WiFi</div></div></div>
          <div class="filters-actions"><button class="btn-reset" onclick="resetFilters()">‚úï R√©initialiser</button></div>
        </div>
      </div>
      <div id="addClubSection" style="display:none"><button class="btn-add-club" onclick="openForm(null)">Ôºã Ajouter un club</button></div>
      <div class="club-list-header" id="clubListHeader"></div>
      <div class="club-list" id="clubList"></div>
    </div>
    <div class="map-panel">
      <div id="mainMap"></div>
      <div class="map-legend" id="mapLegend"></div>
		<!-- AJOUTER juste avant </div> de .map-panel (apr√®s la l√©gende) -->
<div style="position:absolute;bottom:6px;right:10px;z-index:700;background:rgba(255,255,255,.85);padding:3px 10px;border-radius:4px;font-size:.68rem;font-weight:600;color:#1E293B;pointer-events:none;">
  ¬© TourMag.com 2026 ‚Äî Reproduction interdite
</div>
		
      <div class="detail-panel" id="detailPanel">
        <div class="detail-header" id="detailHeader"></div>
        <div class="detail-body" id="detailBody"></div>
      </div>
    </div>
  </div>
</div>
</div>

<div class="login-overlay" id="loginOverlay">
  <div class="login-box" style="text-align:left">
    <h3 style="text-align:center">üîê Connexion Espace TO</h3>
    <p style="text-align:center">Connectez-vous avec votre compte tour-op√©rateur</p>
    <form class="login-form" id="loginForm" onsubmit="handleLogin(event)" style="display:flex;flex-direction:column;gap:14px">
      <div style="display:flex;flex-direction:column;gap:4px">
        <label style="font-size:.82rem;font-weight:600;color:var(--text)">Email</label>
        <input type="email" id="loginEmail" required autocomplete="email" style="padding:10px 12px;border:2px solid var(--border);border-radius:8px;font-family:inherit;font-size:.9rem;outline:none;transition:border-color .2s" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <div style="display:flex;flex-direction:column;gap:4px">
        <label style="font-size:.82rem;font-weight:600;color:var(--text)">Mot de passe</label>
        <input type="password" id="loginPassword" required autocomplete="current-password" style="padding:10px 12px;border:2px solid var(--border);border-radius:8px;font-family:inherit;font-size:.9rem;outline:none;transition:border-color .2s" onfocus="this.style.borderColor='var(--primary)'" onblur="this.style.borderColor='var(--border)'">
      </div>
      <div class="login-error" id="loginError">Email ou mot de passe incorrect</div>
      <div style="display:flex;gap:10px;margin-top:6px">
        <button type="button" class="login-cancel" onclick="hideLogin()" style="flex:1;padding:11px;border:1.5px solid var(--border);border-radius:8px;background:var(--bg);color:var(--text-light);font-family:inherit;font-size:.9rem;font-weight:600;cursor:pointer">Annuler</button>
        <button type="submit" class="login-btn" id="btnLoginSubmit" style="flex:1;margin-top:0">Se connecter</button>
      </div>
    </form>
  </div>
</div>

<div class="form-overlay" id="formOverlay">
<div class="form-box">
  <div class="form-header" id="formHeader"><h3 id="formTitle">Ajouter un club</h3><button class="form-close" onclick="closeForm()">‚úï</button></div>
  <div class="form-body">
    <div class="form-row">
      <div class="form-group"><label>Nom du club *</label><input type="text" id="fNom"></div>
      <div class="form-group"><label>Nombre d'√©toiles *</label><select id="fEtoiles"><option value="2">2 √©toiles</option><option value="3">3 √©toiles</option><option value="4" selected>4 √©toiles</option><option value="4 SUP">4 √©toiles SUP</option><option value="5">5 √©toiles</option><option value="5 SUP">5 √©toiles SUP</option></select></div>
    </div>
    <div class="form-row" id="fBrandRow" style="display:none">
      <div class="form-group"><label>Marque du club *</label><select id="fBrand"></select></div>
      <div class="form-group"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Pays *</label><input type="text" id="fPays" placeholder="Ex: Gr√®ce"></div>
      <div class="form-group"><label>Ville *</label><input type="text" id="fVille" placeholder="Ex: H√©raklion"></div>
    </div>
    <div class="form-map-section">
      <div class="form-map-label">Localisation sur la carte *</div>
      <div class="form-map-help">Cliquez sur la carte pour placer le club.</div>
      <div id="formMap"></div>
      <div class="form-coords">
        <div class="form-group"><label>Latitude</label><input type="text" id="fLat" placeholder="35.3387"></div>
        <div class="form-group"><label>Longitude</label><input type="text" id="fLng" placeholder="25.1442"></div>
      </div>
    </div>
    <div class="form-section-label">H√©bergement</div>
    <div class="form-row">
      <div class="form-group"><label>Nombre de chambres</label><input type="text" id="fChambres"></div>
      <div class="form-group"><label>Types de chambres</label><input type="text" id="fTypesChambres" placeholder="Standard, Sup√©rieure‚Ä¶"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label>Adult Only</label><select id="fAdult"><option value="Non">Non</option><option value="Oui">Oui</option><option value="Non sp√©cifi√©">Non sp√©cifi√©</option></select></div>
      <div class="form-group"><label>Acc√®s PMR</label><select id="fPMR"><option value="Non sp√©cifi√©">Non sp√©cifi√©</option><option value="Oui">Oui</option><option value="Non">Non</option></select></div>
    </div>
    <div class="form-row full"><div class="form-group"><label>WiFi</label><input type="text" id="fWifi" placeholder="Gratuit, Payant, Non sp√©cifi√©‚Ä¶"></div></div>
    <div class="form-section-label">Restauration</div>
    <div class="form-row">
      <div class="form-group"><label>All Inclusive</label><select id="fAI"><option value="Oui">Oui</option><option value="Non">Non</option><option value="Non sp√©cifi√©">Non sp√©cifi√©</option></select></div>
      <div class="form-group"><label>Demi-pension</label><select id="fDP"><option value="Non sp√©cifi√©">Non sp√©cifi√©</option><option value="Oui">Oui</option><option value="Non">Non</option></select></div>
    </div>
    <div class="form-row full"><div class="form-group"><label>Buffet disponible</label><select id="fBuffet"><option value="Oui">Oui</option><option value="Non">Non</option><option value="Non sp√©cifi√©">Non sp√©cifi√©</option></select></div></div>
    <div class="form-section-label">Acc√®s & Localisation</div>
    <div class="form-row full"><div class="form-group"><label>Acc√®s direct √† la mer</label><input type="text" id="fMer" placeholder="Oui (en bord de plage), Non (√† 300m)‚Ä¶"></div></div>
    <div class="form-row full"><div class="form-group"><label>Service de transferts</label><select id="fTransferts"><option value="Disponible">Disponible</option><option value="Non sp√©cifi√©">Non sp√©cifi√©</option></select></div></div>
    <div class="form-section-label">Activit√©s & √âquipements</div>
    <div class="form-row full"><div class="form-group"><label>Activit√©s propos√©es</label><textarea id="fActivites" placeholder="Sports collectifs, Excursions‚Ä¶"></textarea></div></div>
    <div class="form-row">
      <div class="form-group"><label>Salle de sport</label><input type="text" id="fSport" placeholder="Oui, Non sp√©cifi√©‚Ä¶"></div>
      <div class="form-group"><label>Piscines</label><input type="text" id="fPiscines" placeholder="2 piscine(s)"></div>
    </div>
    <div class="form-row full"><div class="form-group"><label>√âquipements sportifs</label><input type="text" id="fEquipSport" placeholder="Tennis, Padel‚Ä¶"></div></div>
    <div class="form-section-label">Animation</div>
    <div class="form-row full"><div class="form-group"><label>Animation francophone</label><input type="text" id="fAnimFr" placeholder="Oui (100%), Francophone‚Ä¶"></div></div>
    <div class="form-row">
      <div class="form-group"><label>Animation en journ√©e</label><select id="fAnimJour"><option value="Oui">Oui</option><option value="Non">Non</option><option value="Non sp√©cifi√©">Non sp√©cifi√©</option></select></div>
      <div class="form-group"><label>Animation en soir√©e</label><select id="fAnimSoir"><option value="Oui">Oui</option><option value="Non">Non</option><option value="Non sp√©cifi√©">Non sp√©cifi√©</option></select></div>
    </div>
    <div class="form-row full"><div class="form-group"><label>Clubs enfants / ados</label><input type="text" id="fEnfants" placeholder="Mini-club (4-12 ans), Club ados‚Ä¶"></div></div>
  </div>
  <div class="form-footer">
    <div class="form-saving" id="formSaving"><div class="spinner"></div>Sauvegarde en cours‚Ä¶</div>
    <button class="form-btn-cancel" onclick="closeForm()">Annuler</button>
    <button class="form-btn-save" id="formBtnSave" onclick="saveForm()"><svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Sauvegarder</button>
  </div>
</div>
</div>

<!-- Confirm delete dialog -->
<div class="confirm-overlay" id="confirmOverlay">
  <div class="confirm-box">
    <h3>‚ö† Supprimer ce club ?</h3>
    <p>Vous allez supprimer <span class="club-to-delete" id="confirmClubName"></span>.<br>Cette action est irr√©versible.</p>
    <div class="confirm-btns">
      <button class="btn-confirm-cancel" onclick="hideConfirm()">Annuler</button>
      <button class="btn-confirm-delete" id="btnConfirmDelete">Supprimer</button>
    </div>
  </div>
</div>

<!-- Stats panel (admin only) -->
<div class="stats-overlay" id="statsOverlay">
  <div class="stats-box">
    <div class="stats-header"><h3>üìä Statistiques de fr√©quentation</h3><div style="display:flex;align-items:center;gap:8px"><button onclick="confirmResetStats()" style="display:flex;align-items:center;gap:5px;padding:6px 12px;background:rgba(239,68,68,.25);border:1.5px solid rgba(239,68,68,.5);color:#fff;border-radius:6px;font-family:inherit;font-size:.75rem;font-weight:600;cursor:pointer">üóë R√©initialiser</button><button class="form-close" onclick="closeStats()">‚úï</button></div></div>
    <div class="stats-body" id="statsBody"><div style="text-align:center;padding:40px;color:var(--text-light)"><div class="spinner"></div>Chargement des statistiques‚Ä¶</div></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl/4.1.2/maplibre-gl.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/maplibre-gl-leaflet/0.0.22/leaflet-maplibre-gl.min.js"></script>
<script>
// =====================================================================
// FRENCH BASEMAP ‚Äî CartoDB Voyager vector tiles with French labels
// =====================================================================
const RASTER_FALLBACK = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';

async function addFrenchBasemap(map) {
  // Try MapLibre GL vector tiles first (crisp at any zoom, French labels)
  if (typeof L.maplibreGL === 'function') {
    try {
      const resp = await fetch('https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json');
      if (!resp.ok) throw new Error(resp.status);
      const style = await resp.json();
      // Force French labels on all text layers
      if (style.layers) {
        style.layers.forEach(layer => {
          if (layer.layout && layer.layout['text-field']) {
            layer.layout['text-field'] = [
              'coalesce',
              ['get','name:fr'],
              ['get','name:latin'],
              ['get','name']
            ];
          }
        });
      }
      L.maplibreGL({ style: style, interactive: false }).addTo(map);
      console.log('‚úì MapLibre GL French basemap loaded');
      return;
    } catch(e) {
      console.warn('MapLibre GL failed, falling back to raster:', e);
    }
  }
  // Fallback: CartoDB Voyager raster (no French labels but good quality)
  L.tileLayer(RASTER_FALLBACK, {
    maxZoom: 19,
    attribution: '¬© <a href="https://carto.com/">CARTO</a> ¬© <a href="https://www.openstreetmap.org/copyright">OSM</a>'
  }).addTo(map);
  console.log('‚ö† Fallback raster basemap loaded');
}

// =====================================================================
// FIREBASE CONFIGURATION
// =====================================================================
const firebaseConfig = {
  apiKey: "AIzaSyDxXlf0sPE_mhz5L42QzrVOsXZZWOGbSU8",
  authDomain: "carte-clubs-vacances.firebaseapp.com",
  projectId: "carte-clubs-vacances",
  storageBucket: "carte-clubs-vacances.firebasestorage.app",
  messagingSenderId: "928563758270",
  appId: "1:928563758270:web:377ca1bfde092c8b434aef"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// =====================================================================
// PUBLIC MODE ‚Äî Verified via Firestore (token never in source code)
// =====================================================================
let isPublicMode = false;

async function checkPublicAccess(){
  const params = new URLSearchParams(window.location.search);
  const urlToken = params.get('public');
  if(!urlToken) return false;
  try{
    const doc = await db.collection('config').doc('public_access').get();
    if(!doc.exists) return false;
    const data = doc.data();
    return data.enabled === true && data.token === urlToken;
  }catch(e){
    console.log('Firestore check failed:', e);
    return false;
  }
}

// =====================================================================
// MAPPING: Firebase UID ‚Üí Tour Operator
// =====================================================================
const USER_TO_MAPPING = {
	"iUO2sHUioWPghr1xOtPHVgFHT1Z2": "__ADMIN__",
  "3S7OaHWcVHg8rmvIC35Xqj9HtTA2": "Coralia",        
"DUIENM2TneaelOop1L57CywIVm32": "FRAM",          
  "0Zf4TSURB7R1weR19ty5XUdAc863": "Kappa Club",     
  "n8Hkso8mldbK450x6YKqaTn9I5R2": "Eldorador",     
  "TnHw3XGfVBe9U4R5PIrMS0ICDs92": "H√©liades",       
  "HFHXgpcPHYcjdTVy47QXqVrY7tJ2": "TUI",            
  "0jW4f4WVMLeIraNM6tat6tIMx002": "Mon French Club", 
  "XQt08Ev2sUgsEYDk9P7w4BZHt1V2": "Mondial Tourisme", 
  "Ecy8asFC0QV0Y5iwRh16O3tZSF92": "Naya Club",      
  "KFfh60Ypyyehkl5f6o9102rHxqJ2": "Top of Travel",  
  "Mq1bLIc5gRV2nl91q0iowMY4k9k1": "√îclub",           
	"9azHZOaKRDcwR2sgBnLamZ5oi8i2": "Club Med",          
	"JliDnLXbdNhTqxXhwIb98VK03hB2": "Belambra"           
};

// =====================================================================
// DATA STORAGE: Firestore (collection 'data', document 'clubs')
// =====================================================================
// Marques par TO (pour le formulaire d'ajout)
const TO_MARQUES = {
  "FRAM":["Framissima","Club Jumbo"],
  "TUI":["Marmara","Look√©a"],
  "Kappa Club":["Kappa Club"]
};

// Returns the marque options for a TO (for the add form)
function getMarques(){
  if(!currentTO||isAdmin) return null;
  return TO_MARQUES[currentTO]||null;
}
// Check if logged-in TO can manage a club (simple: TO field matches)
function canManageClub(club){
  if(isAdmin) return true;
  if(!currentTO) return false;
  return (club["Tour Operator"]||'').trim()===currentTO;
}

// ---- COULEURS PAR MARQUE (affichage = marque, pas TO) ----
const BRAND_COLORS = {
  "Framissima":"#264653","Club Jumbo":"#2D6A4F","Look√©a":"#DC2626","Marmara":"#B91C1C",
  "Coralia":"#2A9D8F","Eldorador":"#D4A017",
  "H√©liades":"#F4A261","Kappa Club":"#7C3AED",
  "Mon French Club":"#0284C7",
  "Mondi Club":"#059669","Naya Club":"#D946EF","Top of Travel":"#EA580C","√îclub":"#4F46E5",
  "Club Med":"#E30613"
};
// Fallback: anciennes couleurs TO (pour compatibilit√©)
const TO_COLORS_FALLBACK = {
  "FRAM":"#264653","TUI":"#DC2626","Mondial Tourisme":"#059669"
};
function getColor(brand){return BRAND_COLORS[(brand||'').trim()]||TO_COLORS_FALLBACK[(brand||'').trim()]||'#6B7280'}

// Retourne le nom de marque √† afficher pour un club
function getDisplayBrand(club){
  const marque=(club["Marque"]||'').trim();
  const to=(club["Tour Operator"]||'').trim();
  // Normalize merged brands
  if(marque==="Club Med Exclusive Collection"||marque==="Club Med")return "Club Med";
  if(marque==="Kappa Senses")return "Kappa Club";
  // Mondial Tourisme ‚Üí Mondi Club
  if(to==="Mondial Tourisme"&&(!marque||marque==="Mondial Tourisme"))return "Mondi Club";
  // Si une marque est d√©finie et diff√©rente du TO, utiliser la marque
  if(marque&&marque!==to)return marque;
  // Si le TO a des sous-marques connues mais le club n'en a pas, retourner le TO
  return marque||to;
}

function starsDisplay(val){const s=String(val||'4');const n=parseInt(s)||4;let t='‚òÖ'.repeat(n);if(s.toLowerCase().includes('sup'))t+=' SUP';return t}



// STATE
// =====================================================================
let CLUBS=[],filteredClubs=[],embedMap,mainMap,markerCluster,markers=new Map();
let selectedStars='',legendHighlighted=new Set();
let currentTO=null,isAdmin=false,currentUser=null;
let editingIdx=null;
let formMap=null,formMarker=null;
let deleteIdx=null;

// =====================================================================
// DATA
// =====================================================================
async function loadFromGitHub(){
  try{
    const doc=await db.collection('data').doc('clubs').get();
    if(!doc.exists)throw new Error('Document clubs introuvable dans Firestore');
    const data=doc.data();
    return data.list||[];
  }catch(e){
    console.log('Firestore load failed:',e);
    // Fallback: localStorage
    try{const ls=localStorage.getItem('clubs_vacances_data');if(ls)return JSON.parse(ls)}catch(e2){}
    return null;
  }
}
async function saveToGitHub(data){
  try{
    await db.collection('data').doc('clubs').set({list:data});
  }catch(e){
    // Fallback localStorage
    try{localStorage.setItem('clubs_vacances_data',JSON.stringify(data))}catch(e2){}
    throw e;
  }
}

// =====================================================================
// INIT
// =====================================================================
async function init(){
  // Check public mode FIRST (via Firestore)
  isPublicMode = await checkPublicAccess();
  
  // If public mode, hide TO controls and sign out any existing session
  if(isPublicMode){
    document.getElementById('btnToLogin').style.display='none';
    document.getElementById('btnToLogout').style.display='none';
    document.getElementById('toUserInfo').style.display='none';
    document.getElementById('addClubSection').style.display='none';
    document.getElementById('btnStats').style.display='none';
    auth.signOut();
  }
  
  let data=await loadFromGitHub();
  if(data&&data.length>0){
    CLUBS=data.map(c=>({...c,lat:parseFloat(c.lat)||0,lng:parseFloat(c.lng)||0}));
  }else if(typeof EMBEDDED_DATA!=='undefined'){
    CLUBS=EMBEDDED_DATA;
  }
  // Merge Club Med embedded resorts
  if(typeof CLUBMED_EMBEDDED!=='undefined'&&CLUBMED_EMBEDDED.length>0){
    const cmClubs=CLUBMED_EMBEDDED.map(c=>({...c,lat:parseFloat(c.lat)||0,lng:parseFloat(c.lng)||0}));
    CLUBS=[...CLUBS,...cmClubs];
  }
  if(!CLUBS.length){document.getElementById('embedOverlay').innerHTML='<p style="color:#fff">Erreur: aucune donn√©e</p>';return;}
  filteredClubs=[];
  populateFilters();
  const nPays=[...new Set(CLUBS.map(c=>c.Pays))].length;
  
  if(isPublicMode){
    // Public: show inviting message, no login prompt
    document.getElementById('embedOverlay').innerHTML=`<h2>üåç Carte des Clubs de Vacances</h2><p>${CLUBS.length} clubs √† travers ${nPays} pays</p><button class="embed-cta"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>Explorer la carte</button>`;
  }else{
    // TO mode: require login
    document.getElementById('embedOverlay').innerHTML=`<h2>üåç Carte des Clubs de Vacances</h2><p>${CLUBS.length} clubs √† travers le monde</p><button class="embed-cta"><svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>Ouvrir la carte interactive</button><div class="embed-count">Connectez-vous pour acc√©der aux clubs</div>`;
  }
  embedMap=L.map('embedMap',{zoomControl:false,attributionControl:false,dragging:false,scrollWheelZoom:false,doubleClickZoom:false,touchZoom:false}).setView([35,15],3);
  L.tileLayer(RASTER_FALLBACK,{maxZoom:19}).addTo(embedMap); // lightweight raster for tiny preview
  CLUBS.forEach(c=>{L.circleMarker([c.lat,c.lng],{radius:4,fillColor:getColor(getDisplayBrand(c)),fillOpacity:.8,stroke:true,weight:1,color:'#fff'}).addTo(embedMap)});
}
init();

// =====================================================================
// MODAL
// =====================================================================
let mapReady=false;
let modalOpenTime=null;
	
	
function openModal(force){if(!force&&window.innerWidth<=768){window.open('https://www.tourmag.com/my/tourmag/dossiers_speciaux/2026_03_clubs/carte/carte-clubs-vacances30_avec_copyright_TM_MODIFIED.html?public=TmG2026CarteClubs!&autoopen=1','_blank');return}document.getElementById('modal').classList.add('active');document.body.style.overflow='hidden';if(!mapReady){setTimeout(initMainMap,120);mapReady=true}else setTimeout(()=>mainMap.invalidateSize(),100);modalOpenTime=Date.now();trackEvent('view')}
function fixMapTiles(){if(!mainMap)return;var i=0;var t=setInterval(function(){mainMap.invalidateSize();i++;if(i>=10)clearInterval(t)},300)}
function closeModal(){trackSessionDuration();document.getElementById('modal').classList.remove('active');document.body.style.overflow='';closeDetail()}
document.addEventListener('keydown',e=>{if(e.key==='Escape'){if(document.getElementById('statsOverlay').classList.contains('active'))closeStats();else if(document.getElementById('confirmOverlay').classList.contains('active'))hideConfirm();else if(document.getElementById('formOverlay').classList.contains('active'))closeForm();else if(document.getElementById('loginOverlay').classList.contains('active'))hideLogin();else if(document.getElementById('detailPanel').classList.contains('open'))closeDetail();else closeModal()}});
window.addEventListener('beforeunload', ()=>{ trackSessionDuration(); });

// =====================================================================
// MAP
// =====================================================================
function initMainMap(){
  mainMap=L.map('mainMap',{zoomControl:true,attributionControl:false}).setView([37,15],4);
  addFrenchBasemap(mainMap);
  markerCluster=L.markerClusterGroup({maxClusterRadius:40,spiderfyOnMaxZoom:true,showCoverageOnHover:false,zoomToBoundsOnClick:true});
  mainMap.addLayer(markerCluster);
  applyFilters();buildLegend();
}
function makeIcon(brand){const c=getColor(brand);return L.divIcon({className:'x',html:`<div style="width:14px;height:14px;border-radius:50%;background:${c};border:2.5px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.3)"></div>`,iconSize:[14,14],iconAnchor:[7,7]})}
function renderClubs(){
  markerCluster.clearLayers();markers.clear();
  filteredClubs.forEach(club=>{
    const idx=CLUBS.indexOf(club),brand=getDisplayBrand(club),color=getColor(brand);
    const m=L.marker([club.lat,club.lng],{icon:makeIcon(brand)});
    m.bindPopup(`<div class="popup-inner"><h3>${club["Nom du club"]}</h3><div class="popup-to" style="background:${color}">${brand}</div><p>${club.Ville}, ${club.Pays} ¬∑ ${starsDisplay(club["Nombre d'√©toiles"])}</p><button class="popup-btn" onclick="showDetail(${idx})">Voir la fiche ‚Üí</button></div>`,{closeButton:true,offset:[0,-5]});
    markerCluster.addLayer(m);markers.set(idx,m);
  });
  renderList();
  if(filteredClubs.length>0){mainMap.fitBounds(L.latLngBounds(filteredClubs.map(c=>[c.lat,c.lng])).pad(0.1))}
}

// =====================================================================
// LEGEND
// =====================================================================
function buildLegend(){
  if(!isPublicMode && !currentTO){document.getElementById('mapLegend').innerHTML='';return}
  const visibleClubs=(isPublicMode||isAdmin)?CLUBS:CLUBS.filter(c=>canManageClub(c));
  const bc={};visibleClubs.forEach(c=>{const b=getDisplayBrand(c);bc[b]=(bc[b]||0)+1});
  document.getElementById('mapLegend').innerHTML=`<h4>Clubs de Vacances</h4>`+Object.entries(bc).sort((a,b)=>b[1]-a[1]).map(([b,n])=>`<div class="legend-item" data-brand="${b}" onclick="toggleLegend(this,'${b.replace(/'/g,"\\'")}')"><div class="legend-dot" style="background:${getColor(b)}"></div><span class="legend-label">${b}</span><span class="legend-cnt">${n}</span></div>`).join('');
}
function toggleLegend(el,brand){
  if(legendHighlighted.has(brand)){
    legendHighlighted.delete(brand);
  }else{
    legendHighlighted.add(brand);
  }
  // Update visual state: dim everything except highlighted brands
  document.querySelectorAll('.legend-item').forEach(item=>{
    const b=item.dataset.brand;
    if(legendHighlighted.size===0){
      item.classList.remove('dimmed');
    }else{
      item.classList.toggle('dimmed',!legendHighlighted.has(b));
    }
  });
  applyFilters();
}

// =====================================================================
// LIST
// =====================================================================
function renderList(){
  const list=document.getElementById('clubList'),n=filteredClubs.length;
  document.getElementById('clubListHeader').textContent=n+' club'+(n>1?'s':'')+' trouv√©'+(n>1?'s':'');
  document.getElementById('topbarCount').textContent=n+' club'+(n>1?'s':'');
  if(!n){
    if(!isPublicMode && !currentTO){list.innerHTML='<div class="no-results"><p>üîê Connectez-vous via <b>Espace TO</b><br>pour acc√©der √† vos clubs.</p></div>'}
    else{list.innerHTML='<div class="no-results"><p>Aucun club trouv√©.<br>Modifiez vos filtres.</p></div>'}
    return}
  list.innerHTML=filteredClubs.map(c=>{
    const idx=CLUBS.indexOf(c),brand=getDisplayBrand(c),color=getColor(brand);
    return `<div class="club-item" data-idx="${idx}" onclick="focusClub(${idx})"><div class="club-item-name">${c["Nom du club"]}</div><div class="club-item-meta"><span class="club-item-to" style="background:${color}">${brand}</span><span class="stars">${starsDisplay(c["Nombre d'√©toiles"])}</span><span>${c.Ville}, ${c.Pays}</span></div></div>`;
  }).join('');
}
function focusClub(idx){
  const c=CLUBS[idx],m=markers.get(idx);
  document.querySelectorAll('.club-item').forEach(e=>e.classList.remove('active'));
  const el=document.querySelector(`.club-item[data-idx="${idx}"]`);if(el)el.classList.add('active');
  if(m&&mainMap){mainMap.flyTo([c.lat,c.lng],10,{duration:.8});setTimeout(()=>m.openPopup(),850)}
  showDetail(idx);
}

// =====================================================================
// DETAIL
// =====================================================================
function showDetail(idx){
  const c=CLUBS[idx],p=document.getElementById('detailPanel'),h=document.getElementById('detailHeader'),b=document.getElementById('detailBody');
  trackClubClick(c);
  const to=(c["Tour Operator"]||'').trim(),brand=getDisplayBrand(c),color=getColor(brand);
  const badges=[];
  if(c["All Inclusive"]==='Oui')badges.push('All Inclusive');
  if(c["Adult Only"]==='Oui')badges.push('Adult Only');
  const af=String(c["Animation francophone"]||'').toLowerCase();
  if(af.includes('oui')||af.includes('francophone')||af.includes('100%'))badges.push('Francophone');
  if(String(c["Demi-pension"]||'').startsWith('Oui'))badges.push('Demi-pension');
  
  const canEdit=!isPublicMode && currentTO && canManageClub(c);
  const actionsHtml=canEdit?`<div class="detail-actions"><button class="btn-edit-club" onclick="openForm(${idx})"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>Modifier</button><button class="btn-delete-club" onclick="showConfirmDelete(${idx})"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>Supprimer</button></div>`:'';
  
  h.style.background=color;
  h.innerHTML=`<button class="detail-close" onclick="closeDetail()">‚úï</button><div class="detail-name">${c["Nom du club"]}</div><div class="detail-loc"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>${c.Ville}, ${c.Pays} ¬∑ <span class="stars">${starsDisplay(c["Nombre d'√©toiles"])}</span> ¬∑ ${brand}</div><div class="detail-badges">${badges.map(x=>`<span class="detail-badge">${x}</span>`).join('')}</div>${actionsHtml}`;
  
  function fv(v){const s=String(v||'');if(!s||s==='Non sp√©cifi√©'||s==='Not in source')return'<span style="color:#94A3B8">Non renseign√©</span>';if(s==='Oui')return'<span class="yes">‚úì Oui</span>';if(s==='Non')return'<span class="no">‚úó Non</span>';return s}
  
  b.innerHTML=`
    <div class="detail-section"><div class="detail-section-title">üè† H√©bergement</div><div class="detail-grid"><div class="detail-field"><div class="detail-field-label">Chambres</div><div class="detail-field-value">${fv(c["Nombre de chambres"])}</div></div><div class="detail-field"><div class="detail-field-label">Types</div><div class="detail-field-value">${fv(c["Types de chambres"])}</div></div><div class="detail-field"><div class="detail-field-label">Adult Only</div><div class="detail-field-value">${fv(c["Adult Only"])}</div></div><div class="detail-field"><div class="detail-field-label">Acc√®s PMR</div><div class="detail-field-value">${fv(c["Acc√®s PMR"])}</div></div><div class="detail-field full"><div class="detail-field-label">WiFi</div><div class="detail-field-value">${fv(c["WiFi"])}</div></div></div></div>
    <div class="detail-section"><div class="detail-section-title">üçΩ Restauration</div><div class="detail-grid"><div class="detail-field"><div class="detail-field-label">All Inclusive</div><div class="detail-field-value">${fv(c["All Inclusive"])}</div></div><div class="detail-field"><div class="detail-field-label">Demi-pension</div><div class="detail-field-value">${fv(c["Demi-pension"])}</div></div><div class="detail-field full"><div class="detail-field-label">Buffet</div><div class="detail-field-value">${fv(c["Buffet disponible"])}</div></div></div></div>
    <div class="detail-section"><div class="detail-section-title">üìç Acc√®s & Localisation</div><div class="detail-grid"><div class="detail-field full"><div class="detail-field-label">Acc√®s √† la mer</div><div class="detail-field-value">${fv(c["Acc√®s direct √† la mer"])}</div></div><div class="detail-field full"><div class="detail-field-label">Transferts</div><div class="detail-field-value">${fv(c["Service de transferts"])}</div></div></div></div>
    <div class="detail-section"><div class="detail-section-title">‚ö° Activit√©s & √âquipements</div><div class="detail-grid"><div class="detail-field full"><div class="detail-field-label">Activit√©s</div><div class="detail-field-value">${fv(c["Activit√©s propos√©es"])}</div></div><div class="detail-field"><div class="detail-field-label">Salle de sport</div><div class="detail-field-value">${fv(c["Salle de sport"])}</div></div><div class="detail-field"><div class="detail-field-label">Piscines</div><div class="detail-field-value">${fv(c["Piscines"])}</div></div><div class="detail-field full"><div class="detail-field-label">√âquipements sportifs</div><div class="detail-field-value">${fv(c["√âquipements sportifs"])}</div></div></div></div>
    <div class="detail-section"><div class="detail-section-title">üé∂ Animation</div><div class="detail-grid"><div class="detail-field full"><div class="detail-field-label">Animation francophone</div><div class="detail-field-value">${fv(c["Animation francophone"])}</div></div><div class="detail-field"><div class="detail-field-label">Journ√©e</div><div class="detail-field-value">${fv(c["Animation en journ√©e"])}</div></div><div class="detail-field"><div class="detail-field-label">Soir√©e</div><div class="detail-field-value">${fv(c["Animation en soir√©e"])}</div></div><div class="detail-field full"><div class="detail-field-label">Clubs enfants / ados</div><div class="detail-field-value">${fv(c["Clubs enfants/ados"])}</div></div></div></div>`;
  p.classList.add('open');
}
function closeDetail(){document.getElementById('detailPanel').classList.remove('open');document.querySelectorAll('.club-item').forEach(e=>e.classList.remove('active'))}

// =====================================================================
// FILTERS
// =====================================================================
function populateFilters(){
  const brands=[...new Set(CLUBS.map(c=>getDisplayBrand(c)))].filter(Boolean).sort();
  const pays=[...new Set(CLUBS.map(c=>c.Pays))].filter(Boolean).sort();
  const sTO=document.getElementById('filterTO');brands.forEach(b=>{const o=document.createElement('option');o.value=b;o.textContent=b;sTO.appendChild(o)});
  const sP=document.getElementById('filterPays');pays.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;sP.appendChild(o)});
}
function toggleFilters(){if(window.innerWidth<=768){openFiltersPopup();return}document.getElementById('filtersToggle').classList.toggle('open');document.getElementById('filtersBody').classList.toggle('open')}
function openFiltersPopup(){var src=document.getElementById('filtersBody');var dest=document.getElementById('filtersPopupBody');dest.innerHTML=src.innerHTML;dest.querySelectorAll('.filter-select').forEach(function(sel){var orig=document.getElementById(sel.id);if(orig)sel.value=orig.value;sel.addEventListener('change',function(){var o=document.getElementById(this.id);if(o){o.value=this.value}applyFilters()})});dest.querySelectorAll('.filter-chip').forEach(function(chip,i){var origChips=src.querySelectorAll('.filter-chip');if(origChips[i]&&origChips[i].classList.contains('active'))chip.classList.add('active')});document.getElementById('filtersOverlay').classList.add('active');document.getElementById('filtersOverlay').style.display='flex'}
function closeFiltersPopup(){document.getElementById('filtersOverlay').classList.remove('active');document.getElementById('filtersOverlay').style.display='none'}
function toggleStar(el){document.querySelectorAll('#filterStars .filter-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');selectedStars=el.dataset.val;applyFilters()}
function toggleChip(el){el.classList.toggle('active');applyFilters()}
function resetFilters(){
  document.getElementById('searchInput').value='';document.getElementById('filterTO').value='';document.getElementById('filterPays').value='';selectedStars='';legendHighlighted.clear();
  document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));
  document.querySelector('#filterStars .filter-chip[data-val=""]').classList.add('active');
  document.querySelectorAll('.legend-item').forEach(e=>e.classList.remove('dimmed'));
  applyFilters();
}
function isOk(v){const s=String(v||'').toLowerCase();return s&&s!=='non'&&s!=='non sp√©cifi√©'&&s!=='not in source'}
function isOui(v){return String(v||'').toLowerCase().startsWith('oui')}

function applyFilters(){
  const q=document.getElementById('searchInput').value.toLowerCase().trim();
  const to=document.getElementById('filterTO').value,pays=document.getElementById('filterPays').value;
  const chips=new Set();document.querySelectorAll('.filter-chip[data-filter].active').forEach(e=>chips.add(e.dataset.filter));
  let cnt=0;if(q)cnt++;if(to)cnt++;if(pays)cnt++;if(selectedStars)cnt++;cnt+=chips.size;if(legendHighlighted.size)cnt++;
  const badge=document.getElementById('activeCount');if(cnt>0){badge.style.display='inline-flex';badge.textContent=cnt}else badge.style.display='none';
  
  // Track search & filters (public mode only)
  if(q) trackSearch(q);
  if(to) trackFilter('to', to);
  if(pays) trackFilter('pays', pays);
  if(selectedStars) trackFilter('etoiles', selectedStars);
  chips.forEach(c=>trackFilter('chip', c));
  
  filteredClubs=CLUBS.filter(c=>{
    // === ACCESS CONTROL ===
    if(isPublicMode){
      // Public mode: all clubs visible, no restriction
    }else{
      // TO mode: non connect√© = rien ; TO = ses clubs ; admin = tout
      if(!currentTO) return false;
      if(!isAdmin && (c["Tour Operator"]||'').trim()!==currentTO) return false;
    }
    if(q){const h=[c["Nom du club"],c.Ville,c.Pays,c["Tour Operator"],getDisplayBrand(c),c["Activit√©s propos√©es"],c["√âquipements sportifs"]].join(' ').toLowerCase();if(!h.includes(q))return false}
    const cto=(c["Tour Operator"]||'').trim();const cbrand=getDisplayBrand(c);
    if(to&&cbrand!==to)return false;if(pays&&c.Pays!==pays)return false;
    if(selectedStars){const n=parseInt(String(c["Nombre d'√©toiles"]));if(n!==parseInt(selectedStars))return false}
    if(legendHighlighted.size&&!legendHighlighted.has(getDisplayBrand(c)))return false;
    if(chips.has('allInclusive')&&c["All Inclusive"]!=='Oui')return false;
    if(chips.has('demiPension')&&!isOui(c["Demi-pension"]))return false;
    if(chips.has('buffet')&&c["Buffet disponible"]!=='Oui')return false;
    if(chips.has('adultOnly')&&c["Adult Only"]!=='Oui')return false;
    if(chips.has('enfants')&&!isOk(c["Clubs enfants/ados"]))return false;
    if(chips.has('pmr')){if(String(c["Acc√®s PMR"]||'').toLowerCase()!=='oui')return false}
    if(chips.has('mer')&&!isOui(c["Acc√®s direct √† la mer"]))return false;
    if(chips.has('transferts')&&!isOk(c["Service de transferts"]))return false;
    if(chips.has('piscine')&&!isOk(c["Piscines"]))return false;
    if(chips.has('sport')&&!isOk(c["Salle de sport"]))return false;
    if(chips.has('equipSport')&&!isOk(c["√âquipements sportifs"]))return false;
    if(chips.has('animFr')){const v=String(c["Animation francophone"]||'').toLowerCase();if(!v.includes('oui')&&!v.includes('francophone')&&!v.includes('100%'))return false}
    if(chips.has('animJour')&&!isOk(c["Animation en journ√©e"]))return false;
    if(chips.has('animSoir')&&!isOk(c["Animation en soir√©e"]))return false;
    if(chips.has('wifi')&&!isOk(c["WiFi"]))return false;
    return true;
  });
  if(mainMap)renderClubs();
}

// =====================================================================
// TO LOGIN / LOGOUT
// =====================================================================
// =====================================================================
// FIREBASE AUTH
// =====================================================================
auth.onAuthStateChanged(user => {
  if(isPublicMode) return; // Public mode: ignore auth state
  currentUser = user;
  if (user) {
    const userTO = USER_TO_MAPPING[user.uid];
    if (userTO) {
      isAdmin = (userTO === "__ADMIN__");
      currentTO = isAdmin ? 'Admin' : userTO;
      document.getElementById('btnToLogin').style.display = 'none';
      document.getElementById('btnToLogout').style.display = 'inline-block';
      document.getElementById('toUserInfo').style.display = 'flex';
      document.getElementById('toUserName').textContent = currentTO;
      document.getElementById('toUserDot').style.background = isAdmin ? 'var(--accent)' : 'var(--primary)';
      document.getElementById('addClubSection').style.display = 'block';
      if(isAdmin) document.getElementById('btnStats').style.display = 'inline-flex';
      applyFilters(); buildLegend();
      toast('Connect√© en tant que ' + currentTO, 'success');
    } else {
      auth.signOut();
      toast('Utilisateur non autoris√©', 'error');
    }
  } else {
    currentUser = null; currentTO = null; isAdmin = false;
    document.getElementById('btnToLogin').style.display = 'inline-flex';
    document.getElementById('btnToLogout').style.display = 'none';
    document.getElementById('toUserInfo').style.display = 'none';
    document.getElementById('addClubSection').style.display = 'none';
    document.getElementById('btnStats').style.display = 'none';
    filteredClubs = [];
    applyFilters(); buildLegend(); closeDetail();
  }
});

function showLogin(){
  document.getElementById('loginOverlay').classList.add('active');
  document.getElementById('loginEmail').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginError').style.display = 'none';
  setTimeout(() => document.getElementById('loginEmail').focus(), 200);
}
function hideLogin(){document.getElementById('loginOverlay').classList.remove('active')}

async function handleLogin(e){
  e.preventDefault();
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  const submitBtn = document.getElementById('btnLoginSubmit');
  const errorDiv = document.getElementById('loginError');
  submitBtn.disabled = true; submitBtn.textContent = 'Connexion...';
  errorDiv.style.display = 'none';
  try {
    await auth.signInWithEmailAndPassword(email, password);
    hideLogin();
  } catch (error) {
    console.error('Login error:', error);
    errorDiv.textContent = 'Email ou mot de passe incorrect';
    errorDiv.style.display = 'block';
  } finally {
    submitBtn.disabled = false; submitBtn.textContent = 'Se connecter';
  }
}

function logoutTO(){
  auth.signOut();
  legendHighlighted.clear();
  toast('D√©connexion r√©ussie', 'success');
}

// =====================================================================
// FORM (Add/Edit)
// =====================================================================
function openForm(idx){
  editingIdx=idx;
  const overlay=document.getElementById('formOverlay');
  const title=document.getElementById('formTitle');
  const header=document.getElementById('formHeader');
  const brandRow=document.getElementById('fBrandRow');
  const brandSel=document.getElementById('fBrand');
  
  if(idx!==null){
    title.textContent='Modifier le club';
    header.style.background=getColor(getDisplayBrand(CLUBS[idx]));
    fillForm(CLUBS[idx]);
    brandRow.style.display='none';
  }else{
    title.textContent='Ajouter un club';
    const marques=getMarques();
    if(isAdmin){
      // Admin: show marque selector with all existing marques
      brandRow.style.display='grid';
      const allMarques=[...new Set(CLUBS.map(c=>(c["Marque"]||c["Tour Operator"]||'').trim()))].filter(Boolean).sort();
      brandSel.innerHTML=allMarques.map(b=>`<option value="${b}">${b}</option>`).join('');
      header.style.background='var(--primary)';
    }else if(marques&&marques.length>0){
      // TO with multiple marques (FRAM, TUI): show selector
      brandRow.style.display='grid';
      brandSel.innerHTML=marques.map(b=>`<option value="${b}">${b}</option>`).join('');
      header.style.background=getColor(currentTO);
    }else{
      brandRow.style.display='none';
      header.style.background=getColor(currentTO);
    }
    clearForm();
  }
  overlay.classList.add('active');
  setTimeout(()=>{
    if(formMap){formMap.remove()}
    formMap=L.map('formMap').setView([35,15],3);
    addFrenchBasemap(formMap);
    if(idx!==null&&CLUBS[idx].lat){const c=CLUBS[idx];formMap.setView([c.lat,c.lng],8);formMarker=L.marker([c.lat,c.lng],{draggable:true}).addTo(formMap);formMarker.on('dragend',()=>{const p=formMarker.getLatLng();document.getElementById('fLat').value=p.lat.toFixed(5);document.getElementById('fLng').value=p.lng.toFixed(5)})}
    formMap.on('click',e=>{if(formMarker)formMap.removeLayer(formMarker);formMarker=L.marker(e.latlng,{draggable:true}).addTo(formMap);document.getElementById('fLat').value=e.latlng.lat.toFixed(5);document.getElementById('fLng').value=e.latlng.lng.toFixed(5);formMarker.on('dragend',()=>{const p=formMarker.getLatLng();document.getElementById('fLat').value=p.lat.toFixed(5);document.getElementById('fLng').value=p.lng.toFixed(5)})});
  },200);
}
function closeForm(){document.getElementById('formOverlay').classList.remove('active');document.getElementById('formSaving').style.display='none';document.getElementById('formBtnSave').disabled=false;if(formMap){formMap.remove();formMap=null}formMarker=null}
function clearForm(){
  ['fNom','fPays','fVille','fLat','fLng','fChambres','fTypesChambres','fWifi','fMer','fActivites','fSport','fPiscines','fEquipSport','fAnimFr','fEnfants'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('fEtoiles').value='4';document.getElementById('fAdult').value='Non';document.getElementById('fPMR').value='Non sp√©cifi√©';
  document.getElementById('fAI').value='Oui';document.getElementById('fDP').value='Non sp√©cifi√©';document.getElementById('fBuffet').value='Oui';
  document.getElementById('fTransferts').value='Disponible';document.getElementById('fAnimJour').value='Oui';document.getElementById('fAnimSoir').value='Oui';
}
function fillForm(c){
  document.getElementById('fNom').value=c["Nom du club"]||'';
  document.getElementById('fEtoiles').value=c["Nombre d'√©toiles"]||'4';
  document.getElementById('fPays').value=c.Pays||'';document.getElementById('fVille').value=c.Ville||'';
  document.getElementById('fLat').value=c.lat||'';document.getElementById('fLng').value=c.lng||'';
  document.getElementById('fChambres').value=c["Nombre de chambres"]||'';document.getElementById('fTypesChambres').value=c["Types de chambres"]||'';
  document.getElementById('fAdult').value=c["Adult Only"]||'Non';document.getElementById('fPMR').value=c["Acc√®s PMR"]||'Non sp√©cifi√©';
  document.getElementById('fWifi').value=c["WiFi"]||'';document.getElementById('fAI').value=c["All Inclusive"]||'Oui';
  document.getElementById('fDP').value=c["Demi-pension"]||'Non sp√©cifi√©';document.getElementById('fBuffet').value=c["Buffet disponible"]||'Oui';
  document.getElementById('fMer').value=c["Acc√®s direct √† la mer"]||'';document.getElementById('fTransferts').value=c["Service de transferts"]||'Disponible';
  document.getElementById('fActivites').value=c["Activit√©s propos√©es"]||'';document.getElementById('fSport').value=c["Salle de sport"]||'';
  document.getElementById('fPiscines').value=c["Piscines"]||'';document.getElementById('fEquipSport').value=c["√âquipements sportifs"]||'';
  document.getElementById('fAnimFr').value=c["Animation francophone"]||'';document.getElementById('fAnimJour').value=c["Animation en journ√©e"]||'Oui';
  document.getElementById('fAnimSoir').value=c["Animation en soir√©e"]||'Oui';document.getElementById('fEnfants').value=c["Clubs enfants/ados"]||'';
}
async function saveForm(){
  const nom=document.getElementById('fNom').value.trim();
  const pays=document.getElementById('fPays').value.trim();
  const ville=document.getElementById('fVille').value.trim();
  const lat=parseFloat(document.getElementById('fLat').value);
  const lng=parseFloat(document.getElementById('fLng').value);
  if(!nom){toast('Veuillez entrer le nom du club','error');return}
  if(!pays||!ville){toast('Veuillez entrer le pays et la ville','error');return}
  if(isNaN(lat)||isNaN(lng)){toast('Veuillez placer le club sur la carte','error');return}
  
  let clubTO, clubMarque;
  if(editingIdx!==null){
    clubTO=CLUBS[editingIdx]["Tour Operator"];
    clubMarque=CLUBS[editingIdx]["Marque"]||clubTO;
  }else{
    clubTO=isAdmin?'':currentTO;
    const brandRow=document.getElementById('fBrandRow');
    const brandSel=document.getElementById('fBrand');
    if(brandRow.style.display!=='none'&&brandSel.value){
      clubMarque=brandSel.value;
      // For admin, determine parent TO from marque
      if(isAdmin){
        if(["Framissima","Club Jumbo"].includes(clubMarque))clubTO="FRAM";
        else if(["Marmara","Look√©a"].includes(clubMarque))clubTO="TUI";
        else clubTO=clubMarque;
      }
    }else{
      clubMarque=currentTO;
    }
  }
  
  const club={
    "Nom du club":nom,"Tour Operator":clubTO,"Marque":clubMarque,
    "Nombre d'√©toiles":document.getElementById('fEtoiles').value,
    "Pays":pays,"Ville":ville,"lat":lat,"lng":lng,
    "Nombre de chambres":document.getElementById('fChambres').value.trim(),
    "Types de chambres":document.getElementById('fTypesChambres').value.trim(),
    "Adult Only":document.getElementById('fAdult').value,
    "Acc√®s PMR":document.getElementById('fPMR').value,
    "WiFi":document.getElementById('fWifi').value.trim(),
    "All Inclusive":document.getElementById('fAI').value,
    "Demi-pension":document.getElementById('fDP').value,
    "Buffet disponible":document.getElementById('fBuffet').value,
    "Acc√®s direct √† la mer":document.getElementById('fMer').value.trim(),
    "Service de transferts":document.getElementById('fTransferts').value,
    "Activit√©s propos√©es":document.getElementById('fActivites').value.trim(),
    "Salle de sport":document.getElementById('fSport').value.trim(),
    "Piscines":document.getElementById('fPiscines').value.trim(),
    "√âquipements sportifs":document.getElementById('fEquipSport').value.trim(),
    "Animation francophone":document.getElementById('fAnimFr').value.trim(),
    "Animation en journ√©e":document.getElementById('fAnimJour').value,
    "Animation en soir√©e":document.getElementById('fAnimSoir').value,
    "Clubs enfants/ados":document.getElementById('fEnfants').value.trim()
  };
  document.getElementById('formSaving').style.display='flex';document.getElementById('formBtnSave').disabled=true;
  try{
    if(editingIdx!==null){CLUBS[editingIdx]={...CLUBS[editingIdx],...club}}else{CLUBS.push(club)}
    await saveToGitHub(CLUBS);
    applyFilters();buildLegend();closeForm();closeDetail();
    toast(editingIdx!==null?'Club modifi√© avec succ√®s ‚úì':'Nouveau club ajout√© avec succ√®s ‚úì','success');
  }catch(e){
    console.error('Save error:',e);if(editingIdx===null)CLUBS.pop();
    toast('Erreur de sauvegarde. V√©rifiez la connexion.','error');
    document.getElementById('formSaving').style.display='none';document.getElementById('formBtnSave').disabled=false;
  }
}

// =====================================================================
// DELETE
// =====================================================================
function showConfirmDelete(idx){
  deleteIdx=idx;
  document.getElementById('confirmClubName').textContent=CLUBS[idx]["Nom du club"];
  document.getElementById('confirmOverlay').classList.add('active');
  document.getElementById('btnConfirmDelete').onclick=()=>doDelete();
}
function hideConfirm(){document.getElementById('confirmOverlay').classList.remove('active');deleteIdx=null}
async function doDelete(){
  if(deleteIdx===null)return;
  const idx=deleteIdx;
  const name=CLUBS[idx]["Nom du club"];
  hideConfirm();
  try{
    CLUBS.splice(idx,1);
    await saveToGitHub(CLUBS);
    applyFilters();buildLegend();closeDetail();
    toast(`"${name}" supprim√© avec succ√®s`,'success');
  }catch(e){
    console.error('Delete error:',e);
    toast('Erreur lors de la suppression','error');
  }
}

// =====================================================================
// TOAST
// =====================================================================
function toast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+type;setTimeout(()=>t.classList.add('show'),10);setTimeout(()=>t.classList.remove('show'),3500)}

// =====================================================================
// ANALYTICS ‚Äî Track public visitors only
// =====================================================================
function generateFingerprint(){
  const screen = window.screen;
  const nav = navigator;
  const raw = [
    nav.userAgent,
    nav.language,
    nav.languages ? nav.languages.join(',') : '',
    screen.width + 'x' + screen.height,
    screen.colorDepth,
    new Date().getTimezoneOffset(),
    nav.hardwareConcurrency || '',
    nav.deviceMemory || '',
    nav.platform || '',
    !!window.sessionStorage,
    !!window.indexedDB,
    nav.maxTouchPoints || 0
  ].join('|');
  // Simple hash (djb2)
  let hash = 5381;
  for(let i = 0; i < raw.length; i++){
    hash = ((hash << 5) + hash) + raw.charCodeAt(i);
    hash = hash & hash; // 32-bit
  }
  return 'fp_' + Math.abs(hash).toString(36);
}

const fingerprint = generateFingerprint();
let visitorId;
try{ visitorId = localStorage.getItem('carte_visitor_id'); }catch(e){}
if(!visitorId){
  visitorId = fingerprint + '_' + Math.random().toString(36).substring(2,6);
  try{ localStorage.setItem('carte_visitor_id', visitorId); }catch(e){}
}
const sessionId = Math.random().toString(36).substring(2,10) + Date.now().toString(36);
let searchDebounce = null;


// D√©tecte le domaine h√©bergeur (iframe parent)
function getHostDomain(){
  const isIframe = (window !== window.top);
  if(isIframe){
    try{ return window.top.location.hostname; }catch(e){}
    try{ if(window.location.ancestorOrigins && window.location.ancestorOrigins.length) return window.location.ancestorOrigins[0].replace(/^https?:\/\//,''); }catch(e){}
    if(document.referrer){ try{ return new URL(document.referrer).hostname; }catch(e){} }
    return 'iframe-inconnu';
  }
  if(document.referrer){ try{ return new URL(document.referrer).hostname; }catch(e){} }
  return window.location.hostname;
}
const hostDomain = getHostDomain();

function trackEvent(type, data){
  if(!isPublicMode) return;
  try{
    db.collection('analytics').add({
      type: type,
      data: data || '',
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      session: sessionId,
      visitor: visitorId,
      host: hostDomain
    });
  }catch(e){console.log('Track error:',e)}
}

function trackClubClick(club){
  if(!isPublicMode) return;
  try{
    db.collection('analytics').add({
      type: 'club_click',
      data: club["Nom du club"],
      to: (club["Tour Operator"]||'').trim(),
      pays: club.Pays||'',
      ville: club.Ville||'',
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      session: sessionId,
      host: hostDomain
    });
  }catch(e){console.log('Track error:',e)}
}

function trackSessionDuration(){
  if(!isPublicMode || !modalOpenTime) return;
  const duration = Math.round((Date.now() - modalOpenTime) / 1000);
  modalOpenTime = null;
  if(duration < 1 || duration > 7200) return; // ignore les aberrations
  try{
    db.collection('analytics').add({
      type: 'session_duration',
      data: String(duration),
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      session: sessionId,
      host: hostDomain
    });
  }catch(e){console.log('Track error:',e)}
}

function trackSearch(query){
  if(!isPublicMode || !query || query.length < 2) return;
  clearTimeout(searchDebounce);
  searchDebounce = setTimeout(()=>{
    trackEvent('search', query);
  }, 1500);
}

let filterDebounce = null;

function trackFilter(filterName, filterValue){
  if(!isPublicMode) return;
  clearTimeout(filterDebounce);
  filterDebounce = setTimeout(()=>{
    trackEvent('filter', filterName + ':' + filterValue);
  }, 2000);
}

// =====================================================================
// STATS DASHBOARD (admin only)
// =====================================================================
function openStats(){
  document.getElementById('statsOverlay').classList.add('active');
  loadStats('7d');
}
function closeStats(){document.getElementById('statsOverlay').classList.remove('active')}
	
	async function confirmResetStats(){
  if(!confirm('‚ö† √ätes-vous s√ªr de vouloir supprimer TOUTES les statistiques ?\n\nCette action est irr√©versible.')) return;
  try{
    const snap = await db.collection('analytics').limit(500).get();
    if(snap.empty){ showToast('Aucune statistique √† supprimer','success'); return; }
    const batch = db.batch();
    snap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
    // Si plus de 500 docs, relancer (Firestore limite les batchs √† 500)
    const remaining = await db.collection('analytics').limit(1).get();
    if(!remaining.empty){
      await confirmResetStats(); // R√©cursif pour les lots suivants
      return;
    }
    showToast('Statistiques r√©initialis√©es','success');
    loadStats('7d');
  }catch(e){
    console.error('Reset stats error:',e);
    showToast('Erreur: '+e.message,'error');
  }
}

async function loadStats(period, customFrom, customTo){
  const body = document.getElementById('statsBody');
  body.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-light)"><div class="spinner"></div>Chargement‚Ä¶</div>';
  
  try{
    const now = new Date();
    let since = new Date();
    let until = null;
    
    if(period==='custom' && customFrom){
      since = new Date(customFrom);
      since.setHours(0,0,0,0);
      if(customTo){
        until = new Date(customTo);
        until.setHours(23,59,59,999);
      }
    } else if(period==='today') since.setHours(0,0,0,0);
    else if(period==='7d') since.setDate(since.getDate()-7);
    else if(period==='30d') since.setDate(since.getDate()-30);
    else since = new Date(2020,0,1);
    
    let query = db.collection('analytics')
      .where('timestamp','>=',since)
      .orderBy('timestamp','desc');
    if(until) query = query.where('timestamp','<=',until);
    
    const snap = await query.limit(5000).get();
    
    const events = [];
    snap.forEach(doc=>events.push(doc.data()));
    
    // Compute stats
    const views = events.filter(e=>e.type==='view');
    const clicks = events.filter(e=>e.type==='club_click');
    const searches = events.filter(e=>e.type==='search');
    const filters = events.filter(e=>e.type==='filter');
    const durations = events.filter(e=>e.type==='session_duration');
    
   
    // Visites (nombre d'ouvertures de carte)
    const visits = views.length;
    
    // Temps moyen pass√©
    let avgDuration = 0;
    if(durations.length){
      const totalSec = durations.reduce((sum,e)=>sum+parseInt(e.data||'0',10),0);
      avgDuration = Math.round(totalSec / durations.length);
    }
    const avgMin = Math.floor(avgDuration/60);
    const avgSec = avgDuration%60;
    const avgDisplay = avgMin > 0 ? avgMin+'m '+avgSec+'s' : avgSec+'s';
    
    // Domaines h√©bergeurs
    const hostCounts = {};
    events.forEach(e=>{if(e.host) hostCounts[e.host]=(hostCounts[e.host]||0)+1});
    const topHosts = Object.entries(hostCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const maxHost = topHosts.length?topHosts[0][1]:1;
    
    // Top clubs
    const clubCounts = {};
    clicks.forEach(e=>{clubCounts[e.data]=(clubCounts[e.data]||0)+1});
    const topClubs = Object.entries(clubCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const maxClub = topClubs.length?topClubs[0][1]:1;
    
    // Top TO
    const toCounts = {};
    clicks.forEach(e=>{if(e.to)toCounts[e.to]=(toCounts[e.to]||0)+1});
    const topTO = Object.entries(toCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const maxTO = topTO.length?topTO[0][1]:1;
    
    // Top pays
    const paysCounts = {};
    clicks.forEach(e=>{if(e.pays)paysCounts[e.pays]=(paysCounts[e.pays]||0)+1});
    const topPays = Object.entries(paysCounts).sort((a,b)=>b[1]-a[1]).slice(0,10);
    const maxPays = topPays.length?topPays[0][1]:1;
    
    // Recent searches
    const recentSearches = searches.slice(0,15);
    
    // Period buttons
    const periods = [
      {id:'today',label:"Aujourd'hui"},
      {id:'7d',label:'7 jours'},
      {id:'30d',label:'30 jours'},
      {id:'all',label:'Tout'}
    ];
    
    body.innerHTML = `
      <div class="stats-period">${periods.map(p=>`<button class="stats-period-btn ${p.id===period?'active':''}" onclick="loadStats('${p.id}')">${p.label}</button>`).join('')}</div>
      
      <div class="stats-date-range">
        <span style="font-size:.78rem;font-weight:600;color:var(--text-light)">P√©riode :</span>
        <input type="date" class="stats-date-input" id="statsDateFrom" value="${customFrom||''}">
        <span style="font-size:.78rem;color:var(--text-light)">‚Üí</span>
        <input type="date" class="stats-date-input" id="statsDateTo" value="${customTo||''}">
        <button class="stats-date-btn" onclick="loadStats('custom',document.getElementById('statsDateFrom').value,document.getElementById('statsDateTo').value)">Appliquer</button>
      </div>
      
      <div class="stats-cards">
        
        <div class="stat-card"><div class="stat-card-value">${visits}</div><div class="stat-card-label">Visites (ouvertures)</div></div>
        <div class="stat-card"><div class="stat-card-value">${clicks.length}</div><div class="stat-card-label">Clics sur clubs</div></div>
        <div class="stat-card"><div class="stat-card-value">${avgDisplay}</div><div class="stat-card-label">Temps moyen pass√©</div></div>
        <div class="stat-card"><div class="stat-card-value">${searches.length}</div><div class="stat-card-label">Recherches</div></div>
        <div class="stat-card"><div class="stat-card-value">${filters.length}</div><div class="stat-card-label">Filtres utilis√©s</div></div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <div class="stats-section">
          <h4>Top 10 clubs consult√©s</h4>
          ${topClubs.length?`<table class="stats-table"><thead><tr><th>Club</th><th>Clics</th></tr></thead><tbody>${topClubs.map(([name,cnt])=>`<tr><td>${name}<div class="stats-bar"><div class="stats-bar-fill" style="width:${100*cnt/maxClub}%"></div></div></td><td>${cnt}</td></tr>`).join('')}</tbody></table>`:'<p style="color:var(--text-light);font-size:.85rem">Aucune donn√©e</p>'}
        </div>
        
        <div class="stats-section">
          <h4>Top Tour Op√©rateurs</h4>
          ${topTO.length?`<table class="stats-table"><thead><tr><th>TO</th><th>Clics</th></tr></thead><tbody>${topTO.map(([name,cnt])=>`<tr><td><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${getColor(name)};margin-right:6px"></span>${name}<div class="stats-bar"><div class="stats-bar-fill" style="width:${100*cnt/maxTO}%;background:${getColor(name)}"></div></div></td><td>${cnt}</td></tr>`).join('')}</tbody></table>`:'<p style="color:var(--text-light);font-size:.85rem">Aucune donn√©e</p>'}
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
        <div class="stats-section">
          <h4>Top Pays</h4>
          ${topPays.length?`<table class="stats-table"><thead><tr><th>Pays</th><th>Clics</th></tr></thead><tbody>${topPays.map(([name,cnt])=>`<tr><td>${name}<div class="stats-bar"><div class="stats-bar-fill" style="width:${100*cnt/maxPays}%"></div></div></td><td>${cnt}</td></tr>`).join('')}</tbody></table>`:'<p style="color:var(--text-light);font-size:.85rem">Aucune donn√©e</p>'}
        </div>
        
        <div class="stats-section">
          <h4>Derni√®res recherches</h4>
          ${recentSearches.length?`<table class="stats-table"><thead><tr><th>Terme recherch√©</th></tr></thead><tbody>${recentSearches.map(e=>`<tr><td>${e.data}</td></tr>`).join('')}</tbody></table>`:'<p style="color:var(--text-light);font-size:.85rem">Aucune donn√©e</p>'}
        </div>
      </div>
      
      <div class="stats-section">
        <h4>Domaines h√©bergeurs</h4>
        ${topHosts.length?`<table class="stats-table"><thead><tr><th>Domaine</th><th>√âv√©nements</th></tr></thead><tbody>${topHosts.map(([name,cnt])=>`<tr><td>${name}<div class="stats-bar"><div class="stats-bar-fill" style="width:${100*cnt/maxHost}%"></div></div></td><td>${cnt}</td></tr>`).join('')}</tbody></table>`:'<p style="color:var(--text-light);font-size:.85rem">Aucune donn√©e</p>'}
      </div>
    `;
  }catch(e){
    console.error('Stats error:',e);
    body.innerHTML='<div style="text-align:center;padding:40px;color:var(--danger)">Erreur de chargement des statistiques.<br><br><span style="font-size:.82rem;color:var(--text-light)">'+e.message+'</span></div>';
  }
}


	
(async function(){if(new URLSearchParams(window.location.search).has('autoopen')){while(!CLUBS||CLUBS.length===0){await new Promise(r=>setTimeout(r,200))}openModal(true)}})()
	
</script>
	
	<div class="filters-overlay" id="filtersOverlay" onclick="if(event.target===this)closeFiltersPopup()">
<div class="filters-popup">
<div class="filters-popup-header"><h3>‚öô Filtres avanc√©s</h3><button class="filters-popup-close" onclick="closeFiltersPopup()">‚úï</button></div>
<div class="filters-popup-body" id="filtersPopupBody"></div>
<div class="filters-popup-footer"><button class="btn-reset" onclick="resetFilters();closeFiltersPopup()">‚úï R√©initialiser</button><button class="btn-apply" onclick="applyFilters();closeFiltersPopup()">Appliquer</button></div>
</div>
</div>
</body>
</html>
